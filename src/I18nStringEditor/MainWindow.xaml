<Window
    x:Class="I18nStringEditor.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:I18nStringEditor"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:I18nStringEditor.ViewModels"
    Title="{Binding WindowTitle}"
    Width="1200"
    Height="800"
    MinWidth="900"
    MinHeight="600"
    Closing="Window_Closing"
    Loaded="Window_Loaded"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.InputBindings>
        <!--  快捷键  -->
        <KeyBinding Command="{Binding OpenFileCommand}" Gesture="Ctrl+O" />
        <KeyBinding Command="{Binding SaveFileCommand}" Gesture="Ctrl+S" />
        <KeyBinding Command="{Binding AddStringCommand}" Gesture="Ctrl+N" />
        <KeyBinding Command="{Binding AddGroupCommand}" Gesture="Ctrl+Shift+N" />
        <KeyBinding Command="{Binding CopyStringKeyCommand}" Gesture="Ctrl+Shift+C" />
        <KeyBinding Command="{Binding DeleteSelectedStringCommand}" Gesture="Delete" />
        <KeyBinding Command="{Binding ToggleOtherLanguagesPanelCommand}" Gesture="F3" />
        <KeyBinding
            Key="F"
            Modifiers="Ctrl"
            Command="{x:Static local:MainWindow.FocusSearchBoxCommand}" />
    </Window.InputBindings>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <!--  反向布尔转换器  -->
        <local:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis" />
        <local:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />

        <!--  Segoe Fluent Icons 字体样式  -->
        <Style x:Key="FluentIcon" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Segoe Fluent Icons" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  工具栏  -->
        <ToolBarTray Grid.Row="0">
            <ToolBar Band="0" BandIndex="0">
                <Button Command="{Binding OpenFileCommand}" ToolTip="打开文件 (Ctrl+O)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE838;" Foreground="#D4A017" />
                        <TextBlock VerticalAlignment="Center" Text="打开" />
                    </StackPanel>
                </Button>
                <Button Command="{Binding SaveFileCommand}" ToolTip="保存文件 (Ctrl+S)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE74E;" Foreground="#60CDFF" />
                        <TextBlock VerticalAlignment="Center" Text="保存" />
                    </StackPanel>
                </Button>
                <Separator />
                <Button Command="{Binding AddGroupCommand}" ToolTip="添加分组 (Ctrl+Shift+N)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE8F4;" Foreground="#D4A017" />
                        <TextBlock VerticalAlignment="Center" Text="添加分组" />
                    </StackPanel>
                </Button>
                <Button Command="{Binding AddStringCommand}" ToolTip="添加字符串 (Ctrl+N)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE710;" Foreground="#6CCB5F" />
                        <TextBlock VerticalAlignment="Center" Text="添加字符串" />
                    </StackPanel>
                </Button>
                <Separator />
                <Button Command="{Binding CopyStringKeyCommand}" ToolTip="复制 StringKey (Ctrl+Shift+C)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE8C8;" Foreground="#B4A0FF" />
                        <TextBlock VerticalAlignment="Center" Text="复制 Key" />
                    </StackPanel>
                </Button>
                <Separator />
                <ToggleButton IsChecked="{Binding ShowOtherLanguagesPanel}" ToolTip="显示/隐藏其他语言面板 (F3)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE774;" Foreground="#60CDFF" />
                        <TextBlock VerticalAlignment="Center" Text="其他语言" />
                    </StackPanel>
                </ToggleButton>
                <Separator />
                <!--  主题切换下拉菜单  -->
                <Menu Background="Transparent" VerticalAlignment="Center">
                    <MenuItem ToolTip="切换主题模式">
                        <MenuItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE771;" Foreground="#FFB900" />
                                <TextBlock VerticalAlignment="Center" Text="主题" />
                            </StackPanel>
                        </MenuItem.Header>
                        <MenuItem Command="{Binding SetThemeLightCommand}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{StaticResource FluentIcon}" Text="&#xE706;" Foreground="#FFB900" Margin="0,0,5,0" />
                                    <TextBlock Text="亮色" VerticalAlignment="Center" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding SetThemeDarkCommand}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{StaticResource FluentIcon}" Text="&#xE708;" Foreground="#6B6B6B" Margin="0,0,5,0" />
                                    <TextBlock Text="暗色" VerticalAlignment="Center" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding SetThemeSystemCommand}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{StaticResource FluentIcon}" Text="&#xE770;" Foreground="#60CDFF" Margin="0,0,5,0" />
                                    <TextBlock Text="跟随系统" VerticalAlignment="Center" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                    </MenuItem>
                </Menu>
                <Separator />
                <Button Command="{Binding OpenSettingsCommand}" ToolTip="设置">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="0,0,5,0" Style="{StaticResource FluentIcon}" Text="&#xE713;" Foreground="#9E9E9E" />
                        <TextBlock VerticalAlignment="Center" Text="设置" />
                    </StackPanel>
                </Button>
            </ToolBar>
            <ToolBar Band="0" BandIndex="1">
                <StackPanel Orientation="Horizontal" Margin="5,0">
                    <TextBlock Style="{StaticResource FluentIcon}" Text="&#xE721;" Foreground="#60CDFF" Margin="0,0,5,0" />
                    <TextBlock VerticalAlignment="Center" FontWeight="SemiBold" Text="搜索:" />
                </StackPanel>
                <TextBox
                    x:Name="SearchBox"
                    Width="200"
                    VerticalAlignment="Center"
                    CaretBrush="{DynamicResource {x:Static SystemColors.WindowTextBrushKey}}"
                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                    ToolTip="搜索 (Ctrl+F)" />
            </ToolBar>
        </ToolBarTray>

        <!--  主内容区  -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" MinWidth="200" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  左侧：节点树  -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Border
                    Grid.Row="0"
                    Padding="10,5">
                    <TextBlock FontWeight="Bold" Text="资源节点" />
                </Border>

                <TreeView
                    Grid.Row="1"
                    BorderThickness="0"
                    ItemsSource="{Binding TreeNodes}"
                    SelectedItemChanged="TreeView_SelectedItemChanged">
                    <TreeView.ItemContainerStyle>
                        <Style TargetType="TreeViewItem" BasedOn="{StaticResource {x:Type TreeViewItem}}">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                            <Setter Property="Padding" Value="3" />
                        </Style>
                    </TreeView.ItemContainerStyle>
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontFamily="Segoe Fluent Icons" FontSize="14" Text="&#xE8B7;" Foreground="#D4A017" Margin="0,0,5,0" VerticalAlignment="Center" />
                                <TextBlock VerticalAlignment="Center" Text="{Binding Key}" />
                            </StackPanel>
                            <HierarchicalDataTemplate.ItemContainerStyle>
                                <Style TargetType="TreeViewItem" BasedOn="{StaticResource {x:Type TreeViewItem}}">
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsLeaf}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </HierarchicalDataTemplate.ItemContainerStyle>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                    <TreeView.ContextMenu>
                        <ContextMenu>
                            <MenuItem Command="{Binding AddGroupCommand}" Header="添加子分组" />
                            <MenuItem Command="{Binding SortNodesCommand}" Header="排序子节点" />
                            <Separator />
                            <MenuItem Command="{Binding DeleteSelectedGroupCommand}" Header="删除分组" />
                        </ContextMenu>
                    </TreeView.ContextMenu>
                </TreeView>

                <!--  搜索结果弹出层  -->
                <Popup
                    AllowsTransparency="True"
                    IsOpen="{Binding HasSearchResults, Mode=OneWay}"
                    Placement="Bottom"
                    PlacementTarget="{Binding ElementName=SearchBox}"
                    StaysOpen="False">
                    <Border
                        MinWidth="300"
                        MaxHeight="300"
                        Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}"
                        BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <ListBox
                            MaxHeight="280"
                            ItemsSource="{Binding SearchResults}"
                            SelectionChanged="SearchResults_SelectionChanged">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5" Orientation="Horizontal">
                                        <TextBlock FontWeight="SemiBold" Text="{Binding FullPath}" />
                                        <TextBlock Text=" = " Opacity="0.6" />
                                        <TextBlock
                                            MaxWidth="200"
                                            Foreground="#60CDFF"
                                            Text="{Binding Value}"
                                            TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </Popup>
            </Grid>

            <!--  分隔条  -->
            <GridSplitter
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Stretch" />

            <!--  右侧：编辑面板  -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  上部：字符串列表  -->
                <Grid Grid.Row="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border
                        Grid.Row="0"
                        Padding="5,5">
                        <StackPanel Orientation="Horizontal">
                            <!-- <TextBlock FontWeight="Bold" Text="字符串资源" />
                            <TextBlock Opacity="0.6" Text=" - " /> -->
                            <TextBlock Opacity="0.6" FontWeight="Bold" Text="{Binding SelectedTreeNode.FullPath}" />
                            <TextBlock Opacity="0.6" Text="." />
                        </StackPanel>
                    </Border>

                    <DataGrid
                        Grid.Row="1"
                        AutoGenerateColumns="False"
                        BorderThickness="0"
                        CanUserAddRows="False"
                        CanUserDeleteRows="False"
                        CellEditEnding="DataGrid_CellEditEnding"
                        GridLinesVisibility="Horizontal"
                        ItemsSource="{Binding StringItems}"
                        RowHeaderWidth="0"
                        SelectedItem="{Binding SelectedStringItem}"
                        SelectionMode="Single">
                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border
                                                Padding="2,4"
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter VerticalAlignment="Center" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.CellStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Width="150"
                                Binding="{Binding Key, UpdateSourceTrigger=PropertyChanged}"
                                Header="Key"
                                IsReadOnly="False" />
                            <DataGridTextColumn
                                Width="*"
                                Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                Header="值"
                                IsReadOnly="False" />
                            <DataGridTextColumn
                                Width="200"
                                Binding="{Binding Comment, UpdateSourceTrigger=PropertyChanged}"
                                Header="说明"
                                IsReadOnly="False" />
                        </DataGrid.Columns>
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Command="{Binding AddStringCommand}" Header="添加字符串" />
                                <MenuItem Command="{Binding CopyStringKeyCommand}" Header="复制 StringKey" />
                                <Separator />
                                <MenuItem Command="{Binding DeleteSelectedStringCommand}" Header="删除" />
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>
                </Grid>

                <!--  分隔条  -->
                <GridSplitter
                    Grid.Row="1"
                    Height="5"
                    HorizontalAlignment="Stretch"
                    Visibility="{Binding ShowOtherLanguagesPanel, Converter={StaticResource BoolToVis}}" />

                <!--  下部：其他语言值  -->
                <Grid
                    Grid.Row="2"
                    Visibility="{Binding ShowOtherLanguagesPanel, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border
                        Grid.Row="0"
                        Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontWeight="Bold" Text="其他语言" />
                            <TextBlock Opacity="0.6" Text=" - " />
                            <TextBlock Opacity="0.6" Text="{Binding SelectedStringItem.FullPath}" />
                        </StackPanel>
                    </Border>

                    <DataGrid
                        Grid.Row="1"
                        AutoGenerateColumns="False"
                        BorderThickness="0"
                        CanUserAddRows="False"
                        CanUserDeleteRows="False"
                        GridLinesVisibility="Horizontal"
                        IsReadOnly="True"
                        ItemsSource="{Binding OtherLanguageValues}"
                        RowHeaderWidth="0">
                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="VerticalAlignment" Value="Center" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border
                                                Padding="2,4"
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter VerticalAlignment="Center" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.CellStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Width="150"
                                Binding="{Binding LanguageFile}"
                                Header="语言文件" />
                            <DataGridTextColumn
                                Width="*"
                                Binding="{Binding Value}"
                                Header="值" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Grid>

        <!--  状态栏  -->
        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Opacity="0.6" Text="快捷键: Ctrl+F 搜索 | Ctrl+N 添加字符串 | Ctrl+Shift+C 复制Key | F3 切换语言面板" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <!--  加载遮罩  -->
        <Border
            Grid.RowSpan="3"
            Background="#80000000"
            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Foreground="White" Text="加载中..." />
            </StackPanel>
        </Border>
    </Grid>
</Window>
